<!doctype html>
<html lang="en">
  <%- include('../partials/head.ejs') %>
  <body class="dx-viewport" style="background-color: #ffc107">
    <%- include('../partials/inviteModal.ejs') %>
    <%-include('../partials/header.ejs') %>
    <%-include('../partials/updateBoardModal.ejs') %>
    <%-include('../partials/notice.ejs') %>
    <div class="row">
      <!--  -->
      <%-include('../partials/boardInfoSideBar.ejs') %>
      <!-- ğŸ”¼ë©”ì¸-ì‚¬ì´ë“œ ë„¤ë¹„ -->
      <%-include('../partials/dragAndDrop.ejs') %>
      <%-include('../partials/cardDetail.ejs') %>
    </div>
    <!-- í‘¸í„° -->
    <%-include('../partials/footer.ejs') %>
  </body>
  <script>
    const currentUrl = String(window.location.href);
    let getBoardId = currentUrl.split('/').pop();

    async function getBoardDetail() {
      try {
        const boardDetailData = await axios.get(`/api/boards/${getBoardId}`);
        const boardDetail = boardDetailData.data.data;
        console.log(boardDetail);
        document.querySelector('.kanban').style.backgroundColor =
          boardDetail.backgroundColor;
        document.querySelector('.boardName').innerHTML =
          `${boardDetail.boardTitle} _ `;
        document.querySelector('.boardDescription').innerHTML =
          boardDetail.description;

        const collaboratorData = await axios.get(
          `/api/boards/${getBoardId}/invite`,
        );
        const collaborators = collaboratorData.data.data;
        console.log(collaborators);
        // ì´ˆëŒ€ëœ ìœ ì € ì‚¬ì´ë“œë°”
        collaborators.forEach((data) => {
          let collaborator = `
                <li>
            <div class="nav-link text-white align-items-center">
              <i style="font-size: 21px;">${data.name}</i>
            </div>
          </li>
                `;
          document
            .querySelector('.invitedEmailUl')
            .insertAdjacentHTML('beforeend', collaborator);
        });

        document
          .querySelector('.board-delete-btn')
          .addEventListener('click', async function () {
            try {
              await axios.delete(`/api/boards/${getBoardId}`);
              if (confirm('ì •ë§ ì‚­ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                alert('ì‚­ì œ ì™„ë£Œ!');
                window.location.href = 'http://localhost:3001/api/home';
              } else {
                alert('ì·¨ì†Œí•©ë‹ˆë‹¤.');
              }
            } catch (error) {
              console.error('Error fetching post:', error.message);
            }
          });
      } catch (error) {
        console.log(error);
      }
    }
    getBoardDetail();

    let color = '#7fffd4';
    const colorData = document.getElementsByClassName('square');
    let selectedBox = colorData[0]; // ì²«ë²ˆì§¸ ë°•ìŠ¤ê°€ ë””í´íŠ¸ë¡œ ì„ íƒë¨

    // í´ë¦­ëœ divì˜ ìƒ‰ìƒì„ ì €ì¥í•˜ê³  ì„ íƒëœ í´ë˜ìŠ¤ë¥¼ ê´€ë¦¬í•˜ëŠ” í•¨ìˆ˜
    function getColor(event) {
      color = event.currentTarget.getAttribute('data-color');

      // ê¸°ì¡´ì— ì„ íƒëœ ë°•ìŠ¤ê°€ ìˆìœ¼ë©´ ì„ íƒ í´ë˜ìŠ¤ ì œê±°
      if (selectedBox) {
        selectedBox.classList.remove('selected');
      }

      // í˜„ì¬ í´ë¦­ëœ ë°•ìŠ¤ì— ì„ íƒ í´ë˜ìŠ¤ ì¶”ê°€
      event.currentTarget.classList.add('selected');
      selectedBox = event.currentTarget;
    }

    // ì´ˆê¸° ì„ íƒëœ ë°•ìŠ¤ì— ë””í´íŠ¸ë¡œ selected í´ë˜ìŠ¤ ì¶”ê°€
    selectedBox.classList.add('selected');

    for (let i = 0; i < colorData.length; i++) {
      colorData[i].addEventListener('click', getColor);
    }
    async function updateBoard() {
      console.log(123123);
      const title = document.getElementById('updateTitle').value;
      const description = document.getElementById('updateDescription').value;
      const backgroundColor = color;

      // í´ë¦­ëœ divì˜ ìƒ‰ìƒ ì¶œë ¥
      console.log('Selected Color:', backgroundColor);
      try {
        await axios({
          method: 'PATCH',
          url: `/api/boards/${getBoardId}`,
          data: {
            boardTitle: title,
            description,
            backgroundColor, // í´ë¦­ëœ divì˜ ìƒ‰ìƒì„ ì „ë‹¬
          },
        })
          .then((res) => {
            alert('ë³´ë“œ ìˆ˜ì • ì„±ê³µ!');
            location.reload();
          })
          .catch((error) => {
            console.log(error);
            throw new Error(error);
          });
      } catch (error) {
        console.log(error);
      }
    }

    const updateBtn = document.getElementById('updateBtn');
    updateBtn.addEventListener('click', updateBoard);
  </script>
  <%- include('../partials/scripts.ejs') %>
</html>
