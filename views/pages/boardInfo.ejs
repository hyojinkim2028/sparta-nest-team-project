<!doctype html>
<html lang="en">
  <%- include('../partials/head.ejs') %>
  <body class="dx-viewport" style="background-color: #ffc107">
    <%- include('../partials/loginModal.ejs') %>
    <!--  -->
    <%- include('../partials/inviteModal.ejs') %>
    <!--  -->
    <%-include('../partials/header.ejs') %>
    <%-include('../partials/updateBoardModal.ejs') %>
    <%-include('../partials/notice.ejs') %>
    <div class="row">
      <div class="modal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header"></div>
          </div>
        </div>
      </div>
      <!--  -->
      <!--  -->

      <%-include('../partials/boardInfoSideBar.ejs') %>
      <!-- ğŸ”¼ë©”ì¸-ì‚¬ì´ë“œ ë„¤ë¹„ -->
      <%-include('../partials/dragAndDrop.ejs') %>
      <%-include('../partials/cardDetail.ejs') %>
    </div>
    <!-- í‘¸í„° -->
    <%-include('../partials/footer.ejs') %>
    <script>
      const currentUrl = String(window.location.href);
      let getBoardId = currentUrl.split('/').pop();

      async function getBoardDetail() {
        try {
          const boardDetailData = await axios.get(`/api/boards/${getBoardId}`);
          const boardDetail = boardDetailData.data.data;
          console.log(boardDetail);
          document.querySelector('.kanban').style.backgroundColor =
            boardDetail.backgroundColor;
          document.getElementById('boardName').innerHTML =
            `${boardDetail.boardTitle} _ `;
          document.getElementById('boardDescription').innerHTML =
            boardDetail.description;

          const collaboratorData = await axios.get(
            `/api/boards/${getBoardId}/invite`,
          );
          const collaborators = collaboratorData.data.data;
          console.log(collaborators);
          // ì´ˆëŒ€ëœ ìœ ì € ì‚¬ì´ë“œë°”
          collaborators.forEach((data) => {
            let collaborator = `
                <li>
            <div class="nav-link text-white align-items-center">
              <i style="font-size: 21px;">${data.name}</i>
            </div>
          </li>
                `;
            document
              .querySelector('.invitedEmailUl')
              .insertAdjacentHTML('beforeend', collaborator);
          });

          document
            .querySelector('.board-delete-btn')
            .addEventListener('click', async function () {
              try {
                await axios.delete(`/api/boards/${getBoardId}`);
                if (confirm('ì •ë§ ì‚­ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                  alert('ì‚­ì œ ì™„ë£Œ!');
                  window.location.href = 'http://localhost:3001/api/home';
                } else {
                  alert('ì·¨ì†Œí•©ë‹ˆë‹¤.');
                }
              } catch (error) {
                console.error('Error fetching post:', error.message);
              }
            });
        } catch (error) {
          console.log(error);
        }
      }
      getBoardDetail();

      async function updateBoard() {
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;
        const backgroundColor = color;

        // í´ë¦­ëœ divì˜ ìƒ‰ìƒ ì¶œë ¥
        console.log('Selected Color:', backgroundColor);
        try {
          await axios({
            method: 'PATCH',
            url: `/api/boards/${getBoardId}`,
            data: {
              boardTitle: title,
              description,
              backgroundColor, // í´ë¦­ëœ divì˜ ìƒ‰ìƒì„ ì „ë‹¬
            },
          })
            .then((res) => {
              alert('ë³´ë“œ ìˆ˜ì • ì„±ê³µ!');
              location.reload();
            })
            .catch((error) => {
              console.log(error);
              throw new Error(error);
            });
        } catch (error) {
          console.log(error);
        }
      }

      const updateBtn = document.getElementById('updateBtn');
      updateBtn.addEventListener('click', updateBoard);

      async function createInvite() {
        const inviteEmail = document.getElementById('inviteEmail').value;

        try {
          await axios({
            method: 'POST',
            url: `/api/boards/${getBoardId}/invite`,
            data: {
              email: inviteEmail,
            },
          })
            .then((res) => {
              alert('ì´ˆëŒ€ ì„±ê³µ!');
              location.reload();
            })
            .catch((error) => {
              alert('ì´ˆëŒ€ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ë©”ì¼ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”');
              console.log(error);
              throw new Error(error);
            });
        } catch (error) {
          console.log(error);
        }
      }

      const inviteBtn = document.getElementById('inviteBtn');
      inviteBtn.addEventListener('click', createInvite);
    </script>
  </body>
  <%- include('../partials/scripts.ejs') %>
</html>
